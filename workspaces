#!/usr/bin/env bash

set -e

PREFIX=$HOME/w

die () { echo "$@" >&2; exit 2; }

WORKSPACES_NIX=${NIX_SRC-.}/workspaces.nix

# To variable 'workspaces'
eval_workspaces ()
{
  local config_eval config
  config=`realpath "$1"`
  eval_json=`nix eval -f "$WORKSPACES_NIX" --json --arg pkgs "import <nixpkgs> {}" --argstr config "$config" activation_scripts`
  eval "workspaces=(`jq -r 'to_entries | .[] | "[\(.key)]=\(.value | @sh)"' <<<"$eval_json"`)"
}

open_workspace ()
{
  local wname="$1" wdrv="$2" p
  p=$PREFIX/$wname
  mkdir -p "$p"
  cd "$p"
  exec nix-shell "$wdrv" --run "exec activate"
}

# Options
cmd=${1-}
shift || true
while getopts ":f:" opt; do
	case "$opt" in
		f) config=$OPTARG ;;
		*) exit 2 ;;
	esac
done
shift $((OPTIND-1))

USAGE_OPEN="open -f <config> <workspace name>"
USAGE_LIST="list -f <config>"

case "$cmd" in
  "open")
    wname=${1:?Usage: workspaces $USAGE_OPEN}
    declare -A workspaces
    eval_workspaces "${config:?Usage: workspaces $USAGE_OPEN}"
    wdrv="${workspaces[$wname]}"
    if [[ -z "$wdrv" ]]; then
      die "$wname: No such workspace"
    fi
    open_workspace "$wname" "$wdrv"
    ;;

  "list")
    declare -A workspaces
    eval_workspaces "${config:?Usage: workspaces $USAGE_LIST}"
    for wname in "${!workspaces[@]}"; do
      echo "$wname"
    done
    ;;

  *)
    cat <<EOF >&2
Usage: workspaces { open | list }

  $USAGE_OPEN
    Open the specified workspace. A directory in $PREFIX is created if it
    doesn't exist, the activation script is run and finally the shell is opened.

  $USAGE_LIST
    List workspaces.
EOF
    ;;
esac
